@model InventoryManagementSystem.Models.ViewModels.ShoppingCartViewModel

@{
    ViewData["Title"] = "Shopping Cart";
    Layout = "_Layout";
}

<div class="products-page">
    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="fas fa-shopping-cart"></i> Shopping Cart</h1>
        <p class="page-subtitle">Review your items before checkout</p>
    </div>

    @if (Model.CartItems != null && Model.CartItems.Any())
    {
        <div class="cart-container">
            <!-- Cart Items -->
            <div class="cart-items-section">
                @foreach (var item in Model.CartItems)
                {
                    <div class="cart-item" data-cart-id="@item.ShoppingCartId">
                        <!-- Product Image -->
                        <div class="cart-item-image">
                            @if (!string.IsNullOrEmpty(item.ProductImage))
                            {
                                <img src="@item.ProductImage" alt="@item.ProductName" />
                            }
                            else
                            {
                                <div class="no-image-small">
                                    <i class="fas fa-image"></i>
                                </div>
                            }
                        </div>

                        <!-- Product Info -->
                        <div class="cart-item-info">
                            <h3 class="cart-item-name">@item.ProductName</h3>
                            <p class="cart-item-price">EGP @item.UnitPrice.ToString("N2")</p>
                        </div>

                        <!-- Quantity Controls -->
                        <div class="cart-item-quantity">
                            <label>Quantity:</label>
                            <div class="quantity-controls">
                                <button type="button"
                                        class="qty-btn qty-decrease"
                                        data-action="decrease"
                                        @(item.Quantity <= 1 ? "disabled" : "")>
                                    <i class="fas fa-minus"></i>
                                </button>

                                <input type="number"
                                       class="qty-input"
                                       value="@item.Quantity"
                                       min="1"
                                       max="@item.MaxQuantity"
                                       readonly />

                                <button type="button"
                                        class="qty-btn qty-increase"
                                        data-action="increase"
                                        @(item.Quantity >= item.MaxQuantity ? "disabled" : "")>
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <small class="stock-info">Max: @item.MaxQuantity</small>
                        </div>

                        <!-- Item Total -->
                        <div class="cart-item-total">
                            <span class="item-total-label">Total:</span>
                            <span class="item-total-amount">EGP <span class="item-total-value">@item.TotalPrice.ToString("N2")</span></span>
                        </div>

                        <!-- Remove Button -->
                        <div class="cart-item-actions">
                            <button type="button"
                                    class="btn-remove-item"
                                    data-action="remove"
                                    title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary">
                <div class="summary-card">
                    <h3 class="summary-title">
                        <i class="fas fa-receipt"></i> Order Summary
                    </h3>

                    <div class="summary-details">
                        <div class="summary-row">
                            <span>Items:</span>
                            <span id="cart-count">@Model.CartCount</span>
                        </div>

                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>EGP <span id="cart-subtotal">@Model.CartTotal.ToString("N2")</span></span>
                        </div>

                        <div class="summary-row">
                            <span>Shipping:</span>
                            <span class="text-success">Free</span>
                        </div>

                        <div class="summary-divider"></div>

                        <div class="summary-row summary-total">
                            <span>Total:</span>
                            <span class="total-amount">EGP <span id="cart-total">@Model.CartTotal.ToString("N2")</span></span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="summary-actions">
                        <button type="button" class="btn-checkout" onclick="checkout()">
                            <i class="fas fa-lock"></i> Proceed to Checkout
                        </button>

                        <a asp-controller="Home" asp-action="Index" class="btn-continue">
                            <i class="fas fa-arrow-left"></i> Continue Shopping
                        </a>

                        <button type="button" class="btn-clear-cart" onclick="clearCart()">
                            <i class="fas fa-trash-alt"></i> Clear Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Empty Cart State -->
        <div class="empty-cart">
            <div class="empty-cart-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <h2>Your Cart is Empty</h2>
            <p>Looks like you haven't added anything to your cart yet.</p>
            <a asp-controller="Home" asp-action="Index" class="btn btn-primary-custom btn-lg">
                <i class="fas fa-shopping-bag"></i> Start Shopping
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        // دالة تحديث الكمية
        function updateQuantity(cartId, newQuantity, maxQuantity) {
            if (newQuantity < 1 || newQuantity > maxQuantity) {
                return;
            }

            $.ajax({
                url: '/Cart/UpdateQuantity',
                type: 'POST',
                data: {
                    cartId: cartId,
                    quantity: newQuantity
                },
                success: function (response) {
                    if (response.success) {
                        // تحديث السعر الإجمالي للعنصر
                        $(`[data-cart-id="${cartId}"] .item-total-value`).text(response.itemTotal.toFixed(2));

                        // تحديث ملخص الطلب
                        $('#cart-subtotal').text(response.cartTotal.toFixed(2));
                        $('#cart-total').text(response.cartTotal.toFixed(2));

                        // تحديث عدد العناصر
                        $('#cart-count').text(response.cartCount);

                        // تحديث الـ input field
                        $(`[data-cart-id="${cartId}"] .qty-input`).val(newQuantity);

                        // تحديث حالة الأزرار
                        updateButtonStates(cartId, newQuantity, maxQuantity);

                        // تحديث الـ navbar
                        if (typeof updateNavbarCart === 'function') {
                            updateNavbarCart(response.cartCount);
                        }
                    } else {
                        alert('Error updating quantity: ' + response.message);
                    }
                },
                error: function () {
                    alert('Error updating quantity. Please try again.');
                }
            });
        }

        // دالة إزالة العنصر
        function removeItem(cartId) {
            if (confirm('Are you sure you want to remove this item from your cart?')) {
                $.ajax({
                    url: '/Cart/Remove',
                    type: 'POST',
                    data: { cartId: cartId },
                    success: function (response) {
                        if (response.success) {
                            // إزالة العنصر من الواجهة
                            $(`[data-cart-id="${cartId}"]`).fadeOut(300, function() {
                                $(this).remove();
                                updateCartSummaryAfterRemove(response.cartCount);
                            });

                            // تحديث الـ navbar
                            if (typeof updateNavbarCart === 'function') {
                                updateNavbarCart(response.cartCount);
                            }

                            alert(response.message);
                        } else {
                            alert('Error removing item: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error removing item. Please try again.');
                    }
                });
            }
        }

        // دالة مسح السلة بالكامل
        function clearCart() {
            if (confirm('Are you sure you want to clear your entire cart?')) {
                $.ajax({
                    url: '/Cart/Clear',
                    type: 'POST',
                    success: function (response) {
                        if (response.success) {
                            // استبدال الـ products-page كله
                            $('.products-page').html(`
                                <div class="page-header">
                                    <h1><i class="fas fa-shopping-cart"></i> Shopping Cart</h1>
                                    <p class="page-subtitle">Review your items before checkout</p>
                                </div>
                                <div class="empty-cart">
                                    <div class="empty-cart-icon">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <h2>Your Cart is Empty</h2>
                                    <p>Your cart has been cleared successfully.</p>
                                    <a href="/Home/Index" class="btn btn-primary-custom btn-lg">
                                        <i class="fas fa-shopping-bag"></i> Start Shopping
                                    </a>
                                </div>
                            `);

                            // تحديث الـ navbar
                            if (typeof updateNavbarCart === 'function') {
                                updateNavbarCart(0);
                            }

                            alert(response.message);
                        } else {
                            alert('Error clearing cart: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error clearing cart. Please try again.');
                    }
                });
            }
        }

        // دالة تحديث حالة الأزرار
        function updateButtonStates(cartId, quantity, maxQuantity) {
            const decreaseBtn = $(`[data-cart-id="${cartId}"] .qty-decrease`);
            const increaseBtn = $(`[data-cart-id="${cartId}"] .qty-increase`);

            // تحديث زر النقصان
            if (quantity <= 1) {
                decreaseBtn.prop('disabled', true);
            } else {
                decreaseBtn.prop('disabled', false);
            }

            // تحديث زر الزيادة
            if (quantity >= maxQuantity) {
                increaseBtn.prop('disabled', true);
            } else {
                increaseBtn.prop('disabled', false);
            }
        }

        // دالة تحديث الملخص بعد الإزالة
        function updateCartSummaryAfterRemove(cartCount) {
            if (cartCount === 0) {
                // إذا السلة فاضية - استبدال الـ products-page كله
                $('.products-page').html(`
                    <div class="page-header">
                        <h1><i class="fas fa-shopping-cart"></i> Shopping Cart</h1>
                        <p class="page-subtitle">Review your items before checkout</p>
                    </div>
                    <div class="empty-cart">
                        <div class="empty-cart-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h2>Your Cart is Empty</h2>
                        <p>Looks like you haven't added anything to your cart yet.</p>
                        <a href="/Home/Index" class="btn btn-primary-custom btn-lg">
                            <i class="fas fa-shopping-bag"></i> Start Shopping
                        </a>
                    </div>
                `);
            } else {
                // تحديث العدد فقط
                $('#cart-count').text(cartCount);
            }
        }

        // دالة الدفع
        function checkout() {
            console.log('Proceeding to checkout');
            window.location.href = '@Url.Action("Checkout", "Cart")';
        }

        // تهيئة الأزرار عند تحميل الصفحة
        $(document).ready(function () {
            // تحديث الـ navbar
            if (typeof updateNavbarCart === 'function') {
                updateNavbarCart(@Model.CartCount);
            }

            // إضافة event listeners لأزرار الكمية
            $('.qty-btn').on('click', function() {
                const cartItem = $(this).closest('.cart-item');
                const cartId = cartItem.data('cart-id');
                const currentQty = parseInt(cartItem.find('.qty-input').val());
                const maxQty = parseInt(cartItem.find('.qty-input').attr('max'));
                const action = $(this).data('action');

                if (action === 'increase') {
                    updateQuantity(cartId, currentQty + 1, maxQty);
                } else if (action === 'decrease') {
                    updateQuantity(cartId, currentQty - 1, maxQty);
                }
            });

            // إضافة event listeners لأزرار الإزالة
            $('.btn-remove-item').on('click', function() {
                const cartItem = $(this).closest('.cart-item');
                const cartId = cartItem.data('cart-id');
                removeItem(cartId);
            });
        });
    </script>
}