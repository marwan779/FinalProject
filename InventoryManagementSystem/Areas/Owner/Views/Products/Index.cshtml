@using InventoryManagementSystem.Models.ViewModels.Product
@model List<ProductVM>

@{
    ViewData["Title"] = "Products Management";
    Layout = "_Layout";

}

<div class="products-page">
    <div class="page-header">
        <h1>Products Management</h1>
        <p class="page-subtitle">Manage your inventory products efficiently</p>
    </div>

    <div class="page-actions">
        <a asp-action="CreateProduct" asp-controller="Products" asp-area="Owner" class="btn btn-primary-custom">
            <i class="fas fa-plus"></i> Add New Product
        </a>
    </div>

    @if (Model.Any())
    {
        <div class="table-container">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Unit Price</th>
                        <th>Cost Price</th>
                        <th>Stock</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in Model)
                    {
                        <tr>
                            <td class="product-image-cell">
                                @if (!string.IsNullOrEmpty(product.ProductImagePath))
                                {
                                    <img src="@product.ProductImagePath" alt="@product.Name" class="product-image" />
                                }
                                else
                                {
                                    <div class="no-image">No Image</div>
                                }
                            </td>
                            <td>@product.Name</td>
                            <td class="product-description">@(string.IsNullOrEmpty(product.Description) ? "No description" : (product.Description.Length > 50 ? product.Description.Substring(0, 50) + "..." : product.Description))</td>
                            <td class="product-category">@product.CategoryName</td>
                            <td>EGP @product.UnitPrice.ToString("N2")</td>
                            <td class="product-cost">EGP @product.CostPrice.ToString("N2")</td>
                            <td class="product-stock">
                                <span class="stock-badge @(product.QuantityInStock > 10 ? "in-stock" : product.QuantityInStock > 0 ? "low-stock" : "out-of-stock")">
                                    @product.QuantityInStock
                                </span>
                            </td>
                            <td class="product-date">@product.CreatedAt.ToString("MMM dd, yyyy")</td>
                            <td class="product-date">@product.UpdatedAt.ToString("MMM dd, yyyy")</td>
                            <td class="product-actions">
                                <a asp-area="Owner" asp-controller="Products" asp-action="UpdateProduct" asp-route-productId="@product.ProductId" class="btn btn-edit">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <a href="javascript:void(0);"
                                   data-url="@Url.Action("DeleteProduct", "Products", new { area = "Owner", productId = product.ProductId })"
                                   class="btn btn-delete delete-btn">
                                    <i class="fas fa-trash"></i> Delete
                                </a>
                                <a asp-area="Owner" asp-controller="OwnerPurchaseOrders" asp-action="CreatePurchaseOrder" asp-route-productId="@product.ProductId" class="btn btn-purchase">
                                    <i class="fas fa-shopping-cart"></i> Purchase
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="products-summary">
            <div class="summary-card">
                <h3>@Model.Count</h3>
                <p>Total Products</p>
            </div>
            <div class="summary-card">
                <h3>@Model.Count(p => p.QuantityInStock > 0)</h3>
                <p>In Stock</p>
            </div>
            <div class="summary-card">
                <h3>@Model.Count(p => p.QuantityInStock == 0)</h3>
                <p>Out of Stock</p>
            </div>
        </div>
    }
    else
    {
        <div class="no-products">
            <div class="no-products-icon">
                <i class="fas fa-box-open"></i>
            </div>
            <h2>No Products Found</h2>
            <p>Get started by adding your first product to the inventory.</p>
            <a asp-action="CreateProduct" asp-controller="Products" asp-area="Owner" class="btn btn-primary-custom btn-lg">
                <i class="fas fa-plus"></i> Add Your First Product
            </a>
        </div>
    }
</div>

<style>
    /* Purchase Button Styles */
    .btn-purchase {
        background: var(--success-color);
        color: var(--white);
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-purchase:hover {
            background: var(--primary-dark);
            color: var(--white);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

    /* Product Description Column */
    .product-description {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .summary-card p {
        color: black;
        font-size: 1rem;
        margin: 0;
    }
</style>

@section Scripts {
    <!-- Include SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const deleteButtons = document.querySelectorAll('.delete-btn');

            deleteButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const url = this.getAttribute('data-url');
                    const productName = this.closest('tr').querySelector('td:nth-child(2)').textContent;

                    Swal.fire({
                        title: 'Are you sure?',
                        html: `You are about to delete <strong>"${productName}"</strong>. This action cannot be undone!`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, delete it!',
                        cancelButtonText: 'Cancel',
                        reverseButtons: true,
                        background: 'var(--bg-overlay-dark)',
                        
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Show loading state
                            Swal.fire({
                                title: 'Deleting...',
                                text: 'Please wait while we delete the product',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });

                            // Redirect to delete URL
                            window.location.href = url;
                        }
                    });
                });
            });
        });
    </script>
}